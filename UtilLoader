local UtilitiesLoader = {}

if _G.Stack_UtilLoaderRan then
	return _G.Stack_UtilLoader
end

_G.Stack_UtilLoaderRan = true

local UtilityModules = {
	{Name = "UtilityFunctions", SrcUrl = "https://raw.githubusercontent.com/Number2189/UI/refs/heads/main/Utils"},
	{Name = "Acrylic", SrcUrl = "https://raw.githubusercontent.com/Number2189/UI/refs/heads/main/AcrylicBlur"},
	{Name = "Notifications", SrcUrl = "https://raw.githubusercontent.com/Roras520/Lib/refs/heads/main/Notifications"},
	{Name = "ConfigManager", SrcUrl = "https://raw.githubusercontent.com/Roras520/Lib/refs/heads/main/ConfigManager"},
	{Name = "LoopManager", SrcUrl = "https://raw.githubusercontent.com/Number2189/UI/refs/heads/main/MainLoopModule"},
	{Name = "EspModule", SrcUrl = "https://raw.githubusercontent.com/Roras520/Lib/refs/heads/main/espmodule"}
}

local LoadedModules = {}

function UtilitiesLoader.FindModule(name)
	for _, module in ipairs(UtilityModules) do
		if module.Name == name then
			return module
		end
	end
	return nil
end

function UtilitiesLoader.LoadModule(name)
	if LoadedModules[name] then
		return LoadedModules[name]
	end

	local moduleInfo = UtilitiesLoader.FindModule(name)
	if not moduleInfo then
		return nil
	end

	local success, src = pcall(function()
		return game:HttpGet(moduleInfo.SrcUrl)
	end)

	if not success then
		return nil
	end

	local loadSuccess, loadedFunc = pcall(loadstring, src)
	if not loadSuccess or not loadedFunc then
		return nil
	end

	local executeSuccess, result = pcall(loadedFunc)
	if not executeSuccess then
		return nil
	end
	
	if result == nil then
		return nil
	end

	LoadedModules[name] = result
	return result
end

function UtilitiesLoader.LoadAll()
	local results = {}
	for _, moduleInfo in ipairs(UtilityModules) do
		local module = UtilitiesLoader.LoadModule(moduleInfo.Name)
		results[moduleInfo.Name] = {success = module ~= nil, module = module}
	end
	return results
end

_G.Stack_UtilLoader = UtilitiesLoader
return UtilitiesLoader
