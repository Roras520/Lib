local EspModule = {}

local Players = game:GetService("Players")
local VRService = game:GetService("VRService")

local Config = {
    -- States
	EspEnabled = true,
    BoxesOn = false,
	NamesOn = false,
	ChamsOn = false,
	DotsOn = false,
	HealthBarOn = false,
	DistanceOn = false,
	PulseEnabled = false,
	RainbowEnabled = false,

    -- Colors
	ChamsColor = Color3.fromRGB(0, 170, 255),
	ChamsOutlineColor = Color3.fromRGB(0, 85, 128),
	ChamsFillTransparency = 0.6,
	ChamsOutlineTransparency = 0.36,
	BoxTransparency = 0.39,
	DotTransparency = 0.4,
	BespColor = Color3.fromRGB(0, 170, 255),
	DespColor = Color3.fromRGB(0, 170, 255),
	NespColor = Color3.fromRGB(0, 170, 255),
	RLineColor = Color3.new(1, 0, 0),
	LLineColor = Color3.new(1, 0, 0),
	PulsePrimaryColor = Color3.fromRGB(0, 170, 255),
	PulseSecondaryColor = Color3.fromRGB(0, 255, 170),
	PulseSpeed = 1,
	RainbowSpeed = 1
}

local LocalPlayer = Players.LocalPlayer
local LocalPlayerName = LocalPlayer.Name
local RedC = Color3.fromRGB(255, 0, 0)

-- Helper Functions
function ColorCheck(Player, EnemyColor, FriendlyColor)
	if workspace:FindFirstChild("PowerUps") then
		return (Player:GetAttribute("ModeTeam") == "Traitor") and EnemyColor or FriendlyColor
	elseif LocalPlayer.Team and Player.Team then
		return (LocalPlayer.Team.Name ~= Player.Team) and EnemyColor or FriendlyColor
	else
		return FriendlyColor
	end
end

function ColorMinus(Color, Step)
	return Color3.fromRGB(Color.R - Step, Color.G - Step, Color.B - Step)
end

-- ESP Functions
function CreateChamsHighlight(Character)
    local Player = game.Players:GetPlayerFromCharacter(Character)
    if not Player then return end

    local isTraitor = false
    if workspace:FindFirstChild("PowerUps") then
        isTraitor = (Player:GetAttribute("ModeTeam") == "Traitor")
    elseif LocalPlayer.Team and Player.Team then
        isTraitor = (LocalPlayer.Team.Name ~= Player.Team.Name)
    end

    local ChamsFillColor, ChamsOutlineColor
    if isTraitor then
        ChamsFillColor = Color3.fromRGB(255, 0, 0)
        ChamsOutlineColor = Color3.fromRGB(255, 0, 0)
    else
        ChamsFillColor = Config.ChamsColor or Color3.fromRGB(0, 170, 255)
        ChamsOutlineColor = Config.ChamsOutlineColor or Color3.fromRGB(0, 85, 128)
    end
    local ChamsFillTransparency = Config.ChamsFillTransparency or 0.6
    local ChamsOutlineTransparency = Config.ChamsOutlineTransparency or 0.36

    local Existing = Character:FindFirstChild("chamshighlight")
    if Existing then
        Existing.FillColor = ChamsFillColor
        Existing.OutlineColor = ChamsOutlineColor
        Existing.FillTransparency = ChamsFillTransparency
        Existing.OutlineTransparency = ChamsOutlineTransparency
        return
    end

    local Highlight = Instance.new("Highlight")
    Highlight.Name = "chamshighlight"
    Highlight.Adornee = Character
    Highlight.FillColor = ChamsFillColor
    Highlight.FillTransparency = ChamsFillTransparency
    Highlight.OutlineColor = ChamsOutlineColor
    Highlight.OutlineTransparency = ChamsOutlineTransparency
    Highlight.Parent = Character
end

function CreateMainEspGui(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart") or Character.PrimaryPart
	if not Part then return nil end
	
	local Existing = Part:FindFirstChild("espmain")
	if Existing then return Existing end
	
	local Billboard = Instance.new("BillboardGui", Part)
	Billboard.Name = "espmain"
	Billboard.Adornee = Part
	Billboard.Size = UDim2.new(0, 200, 0, 100)
	Billboard.StudsOffset = Vector3.new(0, 0, 0)
	Billboard.AlwaysOnTop = true
	
	local Container = Instance.new("Frame", Billboard)
	Container.Name = "Container"
	Container.BackgroundTransparency = 1
	Container.Size = UDim2.new(1, 0, 1, 0)
	
	return Billboard
end

function CreateBoxEsp(Character)
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local BoxEspColor = ColorCheck(Player, RedC, Config.BespColor)
	
	local MainGui = CreateMainEspGui(Character)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local Existing = Container:FindFirstChild("BoxFrame")
	
	if Existing then
		local Stroke = Existing:FindFirstChild("UIStroke")
		if Stroke then
			Stroke.Color = BoxEspColor
			Stroke.Transparency = Config.BoxTransparency
		end
		Existing.Visible = Config.BoxesOn
		return
	end
	
	local Frame = Instance.new("Frame", Container)
	Frame.Name = "BoxFrame"
	Frame.BackgroundTransparency = 1
	Frame.Size = UDim2.new(0.8, 0, 1, 0)
	Frame.Position = UDim2.new(0.1, 0, 0, 0)
	Frame.Visible = Config.BoxesOn
	
	local Stroke = Instance.new("UIStroke", Frame)
	Stroke.Thickness = 1.67
	Stroke.Transparency = Config.BoxTransparency
	Stroke.Color = BoxEspColor
end

function CreateDotEsp(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart") or Character:FindFirstChild("Root")
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local DotEspColor = ColorCheck(Player, RedC, Config.DespColor)
	
	if not Part then return end
	
	local MainGui = CreateMainEspGui(Character)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local Existing = Container:FindFirstChild("DotFrame")
	
	if Existing then
		Existing.BackgroundColor3 = DotEspColor
		Existing.Transparency = Config.DotTransparency
		Existing.Visible = Config.DotsOn
		return
	end

	local Dotf = Instance.new("Frame", Container)
	Dotf.Name = "DotFrame"
	Dotf.BackgroundColor3 = DotEspColor
	Dotf.Size = UDim2.new(0, 10, 0, 10)
	Dotf.Position = UDim2.new(0.5, -5, 0.2, 0)
	Dotf.Transparency = Config.DotTransparency
	Dotf.BorderSizePixel = 0
	Dotf.Visible = Config.DotsOn

	local Dotc = Instance.new("UICorner", Dotf)
	Dotc.CornerRadius = UDim.new(0.45, 0)
end

function CreateNameEsp(Character)
	local Head = Character:FindFirstChild("Head")
	if not Head or not Head.Parent then return end
	
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local NameEspColor = ColorCheck(Player, RedC, Config.NespColor)
	
	local MainGui = CreateMainEspGui(Character)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local Existing = Container:FindFirstChild("NameLabel")
	
	if Existing then
		Existing.TextColor3 = NameEspColor
		Existing.Visible = Config.NamesOn
		return
	end
	
	local Namel = Instance.new("TextLabel", Container)
	Namel.Name = "NameLabel"
	Namel.Size = UDim2.new(1, 0, 0, 20)
	Namel.Position = UDim2.new(0, 0, 0, 0)
	Namel.BorderSizePixel = 0
	Namel.BackgroundTransparency = 1
	Namel.Text = Player.Name and Player.Name:upper() or ""
	Namel.TextColor3 = NameEspColor
	Namel.TextStrokeTransparency = 0.5
	Namel.Font = Enum.Font.SourceSansBold
	Namel.TextSize = VRService.VREnabled and 11 or 14
	Namel.Visible = Config.NamesOn
end

function CreateHealthBar(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart")
	local Humanoid = Character:FindFirstChild("Humanoid") or Character:FindFirstChild("VRHealth")
	
	if not Part then return end
	
	local MainGui = CreateMainEspGui(Character)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local Existing = Container:FindFirstChild("HealthBar")
	
	if Existing then
		if Config.HealthBarOn and Humanoid then
			local HealthFill = Existing:FindFirstChild("Fill")
			if HealthFill then
				local healthPercent = Humanoid:IsA("Humanoid") and (Humanoid.Health / Humanoid.MaxHealth) or (Humanoid.Value / 100)
				HealthFill.Size = UDim2.new(healthPercent, 0, 1, 0)
				HealthFill.BackgroundColor3 = Color3.fromRGB(255 * (1 - healthPercent), 255 * healthPercent, 0)
			end
			Existing.BackgroundTransparency = 0
			Existing.Visible = true
		else
			Existing.BackgroundTransparency = 1
			Existing.Visible = false
		end
		return
	end
	
	local HealthBar = Instance.new("Frame", Container)
	HealthBar.Name = "HealthBar"
	HealthBar.Size = UDim2.new(0.25, 0, 0, 6)
	HealthBar.Position = UDim2.new(0.375, 0, 0.15, 0)
	HealthBar.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	HealthBar.BorderSizePixel = 0
	HealthBar.BackgroundTransparency = Config.HealthBarOn and 0 or 1
	HealthBar.Visible = Config.HealthBarOn
	
	local HealthBarCorner = Instance.new("UICorner", HealthBar)
	HealthBarCorner.CornerRadius = UDim.new(0, 3)
	
	local Fill = Instance.new("Frame", HealthBar)
	Fill.Name = "Fill"
	Fill.Size = UDim2.new(1, 0, 1, 0)
	Fill.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
	Fill.BorderSizePixel = 0
	
	local FillCorner = Instance.new("UICorner", Fill)
	FillCorner.CornerRadius = UDim.new(0, 3)
	
	if Config.HealthBarOn and Humanoid then
		local healthPercent = Humanoid:IsA("Humanoid") and (Humanoid.Health / Humanoid.MaxHealth) or (Humanoid.Value / 100)
		Fill.Size = UDim2.new(healthPercent, 0, 1, 0)
		Fill.BackgroundColor3 = Color3.fromRGB(255 * (1 - healthPercent), 255 * healthPercent, 0)
	end
end

function CreateDistanceDisplay(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart")
	if not Part then return end
	
	local MainGui = CreateMainEspGui(Character)
	if not MainGui then return end
	
	local Container = MainGui:FindFirstChild("Container")
	local Existing = Container:FindFirstChild("DistanceText")
	
	if Existing then
		if Config.DistanceOn and LocalPlayer.Character then
			local localTorso = LocalPlayer.Character:FindFirstChild("Torso") or LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
			if localTorso then
				local distance = math.floor((localTorso.Position - Part.Position).Magnitude)
				Existing.Text = "[" .. tostring(distance) .. "]"
			end
		end
		Existing.BackgroundTransparency = 1
		Existing.Visible = Config.DistanceOn
		return
	end
	
	local DistLabel = Instance.new("TextLabel", Container)
	DistLabel.Name = "DistanceText"
	DistLabel.Size = UDim2.new(1, 0, 0, 20)
	DistLabel.Position = UDim2.new(0, 0, 0.25, 0)
	DistLabel.BackgroundTransparency = 1
	DistLabel.Text = "[0]"
	DistLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	DistLabel.TextStrokeTransparency = 0.5
	DistLabel.Font = Enum.Font.RobotoMono
	DistLabel.TextSize = VRService.VREnabled and 10 or 12
	DistLabel.Visible = Config.DistanceOn
	
	if Config.DistanceOn and LocalPlayer.Character then
		local localTorso = LocalPlayer.Character:FindFirstChild("Torso") or LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
		if localTorso then
			local distance = math.floor((localTorso.Position - Part.Position).Magnitude)
			DistLabel.Text = "[" .. tostring(distance) .. "]"
		end
	end
end

function ClearEsp(Type)
	if not LocalPlayer then
		return
	end
	for _, Plr in pairs(game.Players:GetPlayers()) do
		if Plr.Name ~= LocalPlayer.Name and Plr.Character then
			local Part = Plr.Character:FindFirstChild("Torso") or Plr.Character:FindFirstChild("HumanoidRootPart") or Plr.Character.PrimaryPart
			if Part then
				local MainGui = Part:FindFirstChild("espmain")
				if MainGui then
					local Container = MainGui:FindFirstChild("Container")
					if Container then
						if Type == 1 then
							local BoxFrame = Container:FindFirstChild("BoxFrame")
							if BoxFrame then
								BoxFrame.Visible = false
							end
						elseif Type == 2 then
							local NameLabel = Container:FindFirstChild("NameLabel")
							if NameLabel then
								NameLabel.Visible = false
							end
						elseif Type == 3 then
							local Chamsesp = Plr.Character:FindFirstChild("chamshighlight")
							if Chamsesp then
								Chamsesp:Destroy()
							end
						elseif Type == 4 then
							local DotFrame = Container:FindFirstChild("DotFrame")
							if DotFrame then
								DotFrame.Visible = false
							end
						elseif Type == 5 then
							local HealthBar = Container:FindFirstChild("HealthBar")
							if HealthBar then
								HealthBar.BackgroundTransparency = 1
								HealthBar.Visible = false
							end
						elseif Type == 6 then
							local DistanceText = Container:FindFirstChild("DistanceText")
							if DistanceText then
								DistanceText.Visible = false
							end
						end
					end
				end
			end
		end
	end
end

local LastEspUpdate = 0
local RainbowHue = 0
function UpdateAllEsp()
	if not Config.EspEnabled then return end
	local CT = tick()
	
	if Config.RainbowEnabled then
		RainbowHue = (RainbowHue + (0.01 * Config.RainbowSpeed)) % 1
	end
	
	for _, Plr in pairs(game.Players:GetPlayers()) do
		if Plr.Name ~= LocalPlayerName and Plr.Character then
			CreateBoxEsp(Plr.Character)
			CreateNameEsp(Plr.Character)
			if Config.ChamsOn then CreateChamsHighlight(Plr.Character) end
			CreateDotEsp(Plr.Character)
			CreateHealthBar(Plr.Character)
			CreateDistanceDisplay(Plr.Character)
		end
	end
	
	if CT - LastEspUpdate >= 2 then
		LastEspUpdate = CT
	end
	
	if Config.PulseEnabled then
		ApplyPulseEffect()
	end
	
	if Config.RainbowEnabled then
		ApplyRainbowEffect()
	end
end

function ApplyPulseEffect()
	local pulseValue = (math.sin(tick() * Config.PulseSpeed * 2) + 1) / 2
	local pulseColor = Config.PulsePrimaryColor:Lerp(Config.PulseSecondaryColor, pulseValue)
	
	for _, Plr in pairs(game.Players:GetPlayers()) do
		if Plr.Name ~= LocalPlayerName and Plr.Character then
			local Chams = Plr.Character:FindFirstChild("chamshighlight")
			if Chams then
				Chams.FillColor = pulseColor
			end
			
			local Part = Plr.Character:FindFirstChild("Torso") or Plr.Character:FindFirstChild("HumanoidRootPart") or Plr.Character.PrimaryPart
			if Part then
				local MainGui = Part:FindFirstChild("espmain")
				if MainGui then
					local Container = MainGui:FindFirstChild("Container")
					if Container then
						local BoxFrame = Container:FindFirstChild("BoxFrame")
						if BoxFrame then
							local Stroke = BoxFrame:FindFirstChild("UIStroke")
							if Stroke then
								Stroke.Color = pulseColor
							end
						end
					end
				end
			end
		end
	end
end

function ApplyRainbowEffect()
	local rainbowColor = Color3.fromHSV(RainbowHue, 1, 1)
	
	for _, Plr in pairs(game.Players:GetPlayers()) do
		if Plr.Name ~= LocalPlayerName and Plr.Character then
			local Chams = Plr.Character:FindFirstChild("chamshighlight")
			if Chams then
				Chams.FillColor = rainbowColor
				Chams.OutlineColor = rainbowColor
			end
			
			local Part = Plr.Character:FindFirstChild("Torso") or Plr.Character:FindFirstChild("HumanoidRootPart") or Plr.Character.PrimaryPart
			if Part then
				local MainGui = Part:FindFirstChild("espmain")
				if MainGui then
					local Container = MainGui:FindFirstChild("Container")
					if Container then
						local BoxFrame = Container:FindFirstChild("BoxFrame")
						if BoxFrame then
							local Stroke = BoxFrame:FindFirstChild("UIStroke")
							if Stroke then
								Stroke.Color = rainbowColor
							end
						end
						
						local NameLabel = Container:FindFirstChild("NameLabel")
						if NameLabel then
							NameLabel.TextColor3 = rainbowColor
						end
					end
				end
			end
		end
	end
end

function EditConfig(option, value)
	if Config[option] ~= nil then
		Config[option] = value
		print("[Config] Set " .. option .. " to " .. tostring(value))
	else
		warn("[Config] Option '" .. tostring(option) .. "' does not exist.")
	end
end

function GetConfig()
    return Config
end

EspModule.GetConfig = GetConfig
EspModule.EditConfig = EditConfig
EspModule.UpdateAllEsp = UpdateAllEsp
EspModule.ClearEsp = ClearEsp
EspModule.CreateChamsHighlight = CreateChamsHighlight
EspModule.CreateBoxEsp = CreateBoxEsp
EspModule.CreateDotEsp = CreateDotEsp
EspModule.CreateHealthBar = CreateHealthBar
EspModule.CreateDistanceDisplay = CreateDistanceDisplay

return EspModule
