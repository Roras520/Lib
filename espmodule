local EspModule = {}

local Players = game:GetService("Players")
local VRService = game:GetService("VRService")
local Workspace = game:GetService("Workspace")

local Config = {
    -- States
	EspEnabled = true,
    BoxesOn = false,
	NamesOn = false,
	ChamsOn = false,
	HealthbarOn = true,

    -- Colors
	ChamsColor = Color3.fromRGB(0, 170, 255),
	BespColor = Color3.fromRGB(0, 170, 255),
	DespColor = Color3.fromRGB(0, 170, 255),
	NespColor = Color3.fromRGB(0, 170, 255)
}

local LocalPlayer = Players.LocalPlayer
local LocalPlayerName = LocalPlayer.Name
local RedC = Color3.fromRGB(255, 0, 0)

-- Helper Functions
function ColorCheck(Player, EnemyColor, FriendlyColor)
	if workspace:FindFirstChild("PowerUps") then
		return (Player:GetAttribute("ModeTeam") == "Traitor") and EnemyColor or FriendlyColor
	elseif LocalPlayer.Team and Player.Team then
		return (LocalPlayer.Team.Name ~= Player.Team) and EnemyColor or FriendlyColor
	else
		return FriendlyColor
	end
end

function ColorMinus(Color, Step)
	return Color3.fromRGB(Color.R - Step, Color.G - Step, Color.B - Step)
end

-- ESP Functions
function CreateChamsHighlight(Character)
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local ChamsColor = ColorCheck(Player, RedC, Config.ChamsColor)
	local ChamsOutlineColor = ColorMinus(ChamsColor, 15)
	if not Player then return end

	local Existing = Character:FindFirstChild("chamshighlight")
	if Existing then
		Existing.FillColor = ChamsColor
		return
	end

	local Highlight = Instance.new("Highlight")
	Highlight.Name = "chamshighlight"
	Highlight.Adornee = Character
	Highlight.FillColor = ChamsColor
	Highlight.FillTransparency = 0.6
	Highlight.OutlineColor = ChamsOutlineColor
	Highlight.OutlineTransparency = 0.36
	Highlight.Parent = Character
end

function CreateHealthEsp(Character)
	if not Config.HealthbarOn then return end
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local Billboard = Character:FindFirstChild("bespbox")
	if not Player or not Player.Character or not Billboard then return end
	local Humanoid = Player.Character:FindFirstChildOfClass("Humanoid")
	if not Humanoid then return end
	if Billboard:FindFirstChild("healthBarHolder") then
		Billboard.healthBarHolder:Destroy()
	end
	local boxFrame = Billboard:FindFirstChild("Frame")
	local barHeightPx = boxFrame and boxFrame.AbsoluteSize.Y or 80
	local HealthBarHolder = Instance.new("Frame")
	HealthBarHolder.Name = "healthBarHolder"
	HealthBarHolder.BackgroundColor3 = Color3.new(0,0,0)
	HealthBarHolder.BorderSizePixel = 0
	HealthBarHolder.Size = UDim2.new(0, 3, 1, 0)
	HealthBarHolder.Position = UDim2.new(0, -5, 0, 0)
	HealthBarHolder.Parent = Billboard
	local HealthBar = Instance.new("Frame")
	HealthBar.Name = "healthBar"
	HealthBar.BackgroundColor3 = Color3.fromRGB(69, 255, 68)
	HealthBar.BorderSizePixel = 0
	HealthBar.AnchorPoint = Vector2.new(0, 1)
	HealthBar.Position = UDim2.new(0, 0, 1, 0)
	HealthBar.Size = UDim2.new(1, 0, 1, 0)
	HealthBar.Parent = HealthBarHolder
	local function updateHealth(v)
		local ratio = math.clamp(v / Humanoid.MaxHealth, 0, 1)
		HealthBar.Size = UDim2.new(1, 0, ratio, 0)
	end
	updateHealth(Humanoid.Health)
	local healthConn
	healthConn = Humanoid.HealthChanged:Connect(function()
		if Humanoid.Parent == nil or HealthBarHolder.Parent == nil then healthConn:Disconnect() return end
		updateHealth(Humanoid.Health)
	end)
	HealthBarHolder.AncestryChanged:Connect(function(_, parent)
		if not parent and healthConn then healthConn:Disconnect() end
	end)
end

function CreateBoxEsp(Character)
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local BoxEspColor = ColorCheck(Player, RedC, Config.BespColor)
	local Existing = Character:FindFirstChild("bespbox")
	if Existing then 
		local Stroke = Existing:FindFirstChild("Frame") and Existing.Frame:FindFirstChild("UIStroke") 
		if Stroke then Stroke.Color = BoxEspColor end 
		if Config.HealthbarOn then CreateHealthEsp(Character) end
		return 
	end
	local Billboard = Instance.new("BillboardGui", Character)
	Billboard.Name = "bespbox"
	Billboard.Adornee = Character:FindFirstChild("Torso") or Character.PrimaryPart
	Billboard.Size = UDim2.new(4, 0, 5, 0)
	Billboard.StudsOffset = Vector3.new(0, 0.4, 0)
	Billboard.AlwaysOnTop = true
	local Frame = Instance.new("Frame", Billboard)
	Frame.BackgroundTransparency = 1
	Frame.Size = UDim2.new(1, 0, 1, 0)
	local Stroke = Instance.new("UIStroke", Frame)
	Stroke.Thickness = 1.67
	Stroke.Transparency = 0.39
	Stroke.Color = BoxEspColor
	if Config.HealthbarOn then CreateHealthEsp(Character) end
end

function CreateNameEsp(Head)
	local Player = game.Players:GetPlayerFromCharacter(Head.Parent)
	local NameEspColor = ColorCheck(Player, RedC, Config.NespColor)
	local Existing = Head:FindFirstChild("nameesp")
	
	if Existing then
		local NameLabel = Existing:FindFirstChild("NAME")
		if NameLabel then
			NameLabel.TextColor3 = NameEspColor
		end
		return
	end
	
	local Nespbgui = Instance.new("BillboardGui")
	Nespbgui.Name = "nameesp"
	Nespbgui.Adornee = Head
	Nespbgui.AlwaysOnTop = true
	Nespbgui.ExtentsOffset = Vector3.new(0, 4, 0)
	Nespbgui.Size = UDim2.new(0, 200, 0, 20)
	Nespbgui.Parent = Head
	
	local Namel = Instance.new("TextLabel", Nespbgui)
	Namel.Size = UDim2.new(1, 0, 0.3, 0)
	Namel.Name = "NAME"
	Namel.BorderSizePixel = 0
	Namel.BackgroundTransparency = 1
	Namel.Text = Player.Name and Player.Name:upper()
	Namel.TextColor3 = NameEspColor
	Namel.TextStrokeTransparency = 0.5
	Namel.Font = Enum.Font.SourceSansBold
	Namel.TextSize = VRService.VREnabled and 11 or not VRService.VREnabled and 14
end

function ClearEsp(Bncd)
	if not LocalPlayer then
		return
	end
	for _, Plr in pairs(game.Players:GetPlayers()) do
		if Plr.Name ~= LocalPlayer.Name and Plr.Character then
			if Bncd == 1 then
				local Bespbox = Plr.Character:FindFirstChild("bespbox")
				if Bespbox then
					Bespbox:Destroy()
				end
			elseif Bncd == 2 then
				local Head = Plr.Character:FindFirstChild("Head")
				if Head then
					local Nesp = Head:FindFirstChild("nameesp")
					if Nesp then
						Nesp:Destroy()
					end
				end
			elseif Bncd == 3 then
				local Chamsesp = Plr.Character:FindFirstChild("chamshighlight")
				if Chamsesp then
					Chamsesp:Destroy()
				end
			elseif Bncd == 4 then
				local Bespbox = Plr.Character:FindFirstChild("bespbox")
				if Bespbox then
					local healthBarHolder = Bespbox:FindFirstChild("healthBarHolder")
					if healthBarHolder then
                        healthBarHolder.Parent = workspace
						healthBarHolder:Destroy()
					end
				end
			end
		end
	end
end

local LastEspUpdate = 0
function UpdateAllEsp()
	if not Config.EspEnabled then return end
	local CT = tick()
	if CT - LastEspUpdate >= 2 then
		for _, Plr in pairs(game.Players:GetPlayers()) do
			if Plr.Name ~= LocalPlayerName and Plr.Character then
				if Config.BoxesOn then CreateBoxEsp(Plr.Character) end
				if Config.NamesOn then CreateNameEsp(Plr.Character:FindFirstChild("Head")) end
				if Config.ChamsOn then CreateChamsHighlight(Plr.Character) end
                if Config.HealthbarOn then CreateHealthEsp(Plr.Character) end
			end
		end
		LastEspUpdate = CT
	end
end

function EditConfig(option, value)
	if Config[option] ~= nil then
		Config[option] = value
		print("[Config] Set " .. option .. " to " .. tostring(value))
	else
		warn("[Config] Option '" .. tostring(option) .. "' does not exist.")
	end
end

function GetConfig()
    return Config
end

EspModule.GetConfig = GetConfig
EspModule.EditConfig = EditConfig
EspModule.UpdateAllEsp = UpdateAllEsp
EspModule.ClearEsp = ClearEsp

return EspModule
