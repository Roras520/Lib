local EspModule = {}

local Players = game:GetService("Players")
local VRService = game:GetService("VRService")

local Config = {
    -- States
	EspEnabled = true,
	NamesOn = false,
	ChamsOn = false,
	DotsOn = false,
	HealthBarOn = false,
	DistanceOn = false,

    -- Colors
	ChamsColor = Color3.fromRGB(0, 170, 255),
	DespColor = Color3.fromRGB(0, 170, 255),
	NespColor = Color3.fromRGB(0, 170, 255)
}

local LocalPlayer = Players.LocalPlayer
local LocalPlayerName = LocalPlayer.Name
local RedC = Color3.fromRGB(255, 0, 0)

-- Helper Functions
function ColorCheck(Player, EnemyColor, FriendlyColor)
	if workspace:FindFirstChild("PowerUps") then
		return (Player:GetAttribute("ModeTeam") == "Traitor") and EnemyColor or FriendlyColor
	elseif LocalPlayer.Team and Player.Team then
		return (LocalPlayer.Team.Name ~= Player.Team) and EnemyColor or FriendlyColor
	else
		return FriendlyColor
	end
end

function ColorMinus(Color, Step)
	return Color3.fromRGB(Color.R - Step, Color.G - Step, Color.B - Step)
end

-- ESP Functions
function CreateChamsHighlight(Character)
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local ChamsColor = ColorCheck(Player, RedC, Config.ChamsColor)
	local ChamsOutlineColor = ColorMinus(ChamsColor, 15)
	if not Player then return end

	local Existing = Character:FindFirstChild("chamshighlight")
	if Existing then
		Existing.FillColor = ChamsColor
		return
	end

	local Highlight = Instance.new("Highlight")
	Highlight.Name = "chamshighlight"
	Highlight.Adornee = Character
	Highlight.FillColor = ChamsColor
	Highlight.FillTransparency = 0.6
	Highlight.OutlineColor = ChamsOutlineColor
	Highlight.OutlineTransparency = 0.36
	Highlight.Parent = Character
end


function CreateDotEsp(Character)
	local Part = Character:FindFirstChild("Torso") or Character:FindFirstChild("HumanoidRootPart") or Character:FindFirstChild("Root")
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local DotEspColor = ColorCheck(Player, RedC, Config.DespColor)
	if not Part then
		return
	end

	if Part:FindFirstChild("dotespbg") then
		local Dotf = Part:FindFirstChild("dotespbg"):FindFirstChild("dotf")
		if Dotf then
			Dotf.BackgroundColor3 = DotEspColor
		end
		return
	end

	local Billboard = Instance.new("BillboardGui", Part)
	Billboard.Name = "dotespbg"
	Billboard.Adornee = Part
	Billboard.StudsOffset = Vector3.new(0, 0.4, 0)
	Billboard.Size = UDim2.new(0.1, 5, 0.1, 5)
	Billboard.AlwaysOnTop = true
	Billboard.Enabled = true

	local Dotf = Instance.new("Frame", Billboard)
	Dotf.Name = "dotf"
	Dotf.BackgroundColor3 = DotEspColor
	Dotf.Size = UDim2.new(1, 0, 1, 0)
	Dotf.Transparency = 0.4
	Dotf.BorderSizePixel = 0

	local Dotc = Instance.new("UICorner", Dotf)
	Dotc.CornerRadius = UDim.new(0.45, 0)
end

function CreateNameEsp(Head)
	local Player = game.Players:GetPlayerFromCharacter(Head.Parent)
	local NameEspColor = ColorCheck(Player, RedC, Config.NespColor)
	local Existing = Head:FindFirstChild("nameesp")
	
	local Character = Head.Parent
	local LocalHead = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")
	local Distance = LocalHead and math.floor((Head.Position - LocalHead.Position).Magnitude) or 0
	
	local NameText = Player.Name and Player.Name:upper() or ""
	if Config.DistanceOn then
		NameText = NameText .. " - [" .. tostring(Distance) .. "]"
	end
	
	if Existing then
		local NameLabel = Existing:FindFirstChild("NAME")
		if NameLabel then
			NameLabel.TextColor3 = NameEspColor
			NameLabel.Text = NameText
		end
		return
	end
	
	local Nespbgui = Instance.new("BillboardGui")
	Nespbgui.Name = "nameesp"
	Nespbgui.Adornee = Head
	Nespbgui.AlwaysOnTop = true
	Nespbgui.ExtentsOffset = Vector3.new(0, 4, 0)
	Nespbgui.Size = UDim2.new(0, 200, 0, 20)
	Nespbgui.Parent = Head
	
	local Namel = Instance.new("TextLabel", Nespbgui)
	Namel.Size = UDim2.new(1, 0, 0.3, 0)
	Namel.Name = "NAME"
	Namel.BorderSizePixel = 0
	Namel.BackgroundTransparency = 1
	Namel.Text = NameText
	Namel.TextColor3 = NameEspColor
	Namel.TextStrokeTransparency = 0.5
	Namel.Font = Enum.Font.SourceSansBold
	Namel.TextSize = VRService.VREnabled and 11 or not VRService.VREnabled and 14
end

function CreateHealthBar(Character)
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local Head = Character:FindFirstChild("Head")
	if not Head then return end
	
	local Existing = Head:FindFirstChild("healthbar")
	if Existing then
		local HealthBarBg = Existing:FindFirstChild("HealthBarBg")
		if HealthBarBg then
			local HealthBar = HealthBarBg:FindFirstChild("HealthBar")
			local HealthLabel = HealthBarBg:FindFirstChild("HealthLabel")
			if HealthBar and HealthLabel then
				local Humanoid = Character:FindFirstChild("Humanoid")
				if Humanoid then
					local HealthPercent = math.clamp(Humanoid.Health / Humanoid.MaxHealth, 0, 1)
					HealthBar.Size = UDim2.new(HealthPercent, 0, 1, 0)
					HealthLabel.Text = math.floor(Humanoid.Health) .. "/" .. math.floor(Humanoid.MaxHealth)
					
					if HealthPercent > 0.5 then
						HealthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
					elseif HealthPercent > 0.25 then
						HealthBar.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
					else
						HealthBar.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
					end
				end
			end
		end
		return
	end
	
	local HealthBarGui = Instance.new("BillboardGui")
	HealthBarGui.Name = "healthbar"
	HealthBarGui.Adornee = Head
	HealthBarGui.AlwaysOnTop = true
	HealthBarGui.ExtentsOffset = Vector3.new(0, 3.5, 0)
	HealthBarGui.Size = UDim2.new(0, 100, 0, 8)
	HealthBarGui.Parent = Head
	
	local HealthBarBg = Instance.new("Frame", HealthBarGui)
	HealthBarBg.Name = "HealthBarBg"
	HealthBarBg.Size = UDim2.new(1, 0, 1, 0)
	HealthBarBg.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	HealthBarBg.BorderSizePixel = 1
	HealthBarBg.BorderColor3 = Color3.fromRGB(60, 60, 60)
	
	local HealthBar = Instance.new("Frame", HealthBarBg)
	HealthBar.Name = "HealthBar"
	HealthBar.Size = UDim2.new(1, 0, 1, 0)
	HealthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
	HealthBar.BorderSizePixel = 0
	
	local Humanoid = Character:FindFirstChild("Humanoid")
	if Humanoid then
		local HealthPercent = math.clamp(Humanoid.Health / Humanoid.MaxHealth, 0, 1)
		HealthBar.Size = UDim2.new(HealthPercent, 0, 1, 0)
		
		if HealthPercent > 0.5 then
			HealthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
		elseif HealthPercent > 0.25 then
			HealthBar.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
		else
			HealthBar.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
		end
	end
	
	local HealthLabel = Instance.new("TextLabel", HealthBarBg)
	HealthLabel.Name = "HealthLabel"
	HealthLabel.Size = UDim2.new(1, 0, 1, 0)
	HealthLabel.BackgroundTransparency = 1
	HealthLabel.Text = Humanoid and (math.floor(Humanoid.Health) .. "/" .. math.floor(Humanoid.MaxHealth)) or "0/100"
	HealthLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
	HealthLabel.TextStrokeTransparency = 0.5
	HealthLabel.Font = Enum.Font.SourceSansBold
	HealthLabel.TextSize = 8
end

function ClearEsp(Bncd)
	if not LocalPlayer then
		return
	end
	for _, Plr in pairs(game.Players:GetPlayers()) do
		if Plr.Name ~= LocalPlayer.Name and Plr.Character then
			if Bncd == 2 then
				local Head = Plr.Character:FindFirstChild("Head")
				if Head then
					local Nesp = Head:FindFirstChild("nameesp")
					if Nesp then
						Nesp:Destroy()
					end
				end
			elseif Bncd == 3 then
				local Chamsesp = Plr.Character:FindFirstChild("chamshighlight")
				if Chamsesp then
					Chamsesp:Destroy()
				end
			elseif Bncd == 4 then
				local Torso = Plr.Character:FindFirstChild("Torso") or Plr.Character:FindFirstChild("HumanoidRootPart")
				if Torso then
					local Dotesp = Torso:FindFirstChild("dotespbg")
					if Dotesp then
						Dotesp:Destroy()
					end
				end
			elseif Bncd == 5 then
				local Head = Plr.Character:FindFirstChild("Head")
				if Head then
					local HealthBar = Head:FindFirstChild("healthbar")
					if HealthBar then
						HealthBar:Destroy()
					end
				end
			end
		end
	end
end

local LastEspUpdate = 0
function UpdateAllEsp()
	if not Config.EspEnabled then return end
	local CT = tick()
	if CT - LastEspUpdate >= 0.1 then
		for _, Plr in pairs(game.Players:GetPlayers()) do
			if Plr.Name ~= LocalPlayerName and Plr.Character then
				if Config.NamesOn then CreateNameEsp(Plr.Character:FindFirstChild("Head")) end
				if Config.HealthBarOn then CreateHealthBar(Plr.Character) end
				if Config.ChamsOn then CreateChamsHighlight(Plr.Character) end
				if Config.DotsOn then CreateDotEsp(Plr.Character) end
			end
		end
		LastEspUpdate = CT
	end
end

function EditConfig(option, value)
	if Config[option] ~= nil then
		Config[option] = value
		print("[Config] Set " .. option .. " to " .. tostring(value))
	else
		warn("[Config] Option '" .. tostring(option) .. "' does not exist.")
	end
end

function GetConfig()
    return Config
end

EspModule.GetConfig = GetConfig
EspModule.EditConfig = EditConfig
EspModule.UpdateAllEsp = UpdateAllEsp
EspModule.ClearEsp = ClearEsp
EspModule.CreateHealthBar = CreateHealthBar

return EspModule
